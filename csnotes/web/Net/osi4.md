# OSI-网络层
## 网络层的功能
### 异构网络互连
网络层（Network Layer）是OSI模型中的第三层，提供路由和寻址的功能，使两终端系统能够互连且决定最佳路径，并具有一定的拥塞控制和流量控制的能力。由于TCP/IP协议体系中的网络层功能由IP协议规定和实现，故又称 IP 层。

与 IP 协议配套使用的还有三个协议：

- 地址解析协议 ARP（Address Resolution Protocol）
- 网际控制报文协议 ICMP（Internet Control Message Protocol）
- 网际组管理协议 IGMP（Internet Group Management Protocol）

### 路由与并发
路由器主要完成两个功能：路由选择（确定转发路径）与分组转发（当一个分组到达时所采取的动作）：

1. 路由选择：指按照复杂的分布式算法，根据从各相邻路由器所得到的关于整个网络拓扑的变化情况，动态地改变所选择的路由；
2. 分组转发：指路由器根据转发表将用户的 IP 数据报从合适的端口转发出去。

### 拥塞控制
在通信子网中，由于出现过量的分组而引起网络性能下降的现象称为拥塞。判断网络是否进入拥塞状态的方法是观察网络的吞吐量于网络负载的关系：若网络吞吐量随着负载的增加而出现下降趋势，那么网络就可能进入了“轻度拥塞”状态；当吞吐量下降到零，网络就可能进入了死锁状态。

流量控制与拥塞控制的区别：流量控制往往指发送端和接受端之间点对点信息量的控制，其核心是控制发送端的发送速律，以便接收。而拥塞控制需要确保通信子网能够传送待传送的数据，是一个全局性的过程，单一的增加资源并不能解决拥塞。其控制方法有两种：

1. 开环控制：设计网络是就考虑拥塞情况，是一种静态预防方法，其特点是：路由器做决定时不考虑当前网络状态。
2. 闭环控制：事先不考虑拥塞因素，采用监测网络系统去监视，核心思想是建立反馈环路，是一种动态的方法。

## 路由算法

### 静态路由与动态路由
- 静态路由算法（非自适应路由算法）：由网络管理员手动配置、更新路由信息，特点是稳定、安全、可靠，但不适用于大型和复杂的网络。
- 动态路由算法（自适应路由算法）：相互连接的路由器之间彼此交换信息，然后通过一定的算法优化出路由表项，适用于复杂、频繁改动的网络，但会一定程度上增加网络负担。常用算法有两种：距离-向量路由算法（如 RIP 算法）和链路状态路由算法（如 OSPF 算法）。

### 距离-向量路由算法
所有结点都定期将它们的整个路由选择表传给所有与之直接相邻的节点。其中包括：
1. 每条路径的目的地，即另一结点；
2. 路径的代价，也称距离（如 RIP ，跳数）。

### 链路状态路由算法
这种算法要求每个参与该算法的结点都有完全的网络拓扑信息。它们执行两个任务：
1. 主动测试所有邻接点的状态；
2. 定期将链路状态传播给所有其他的结点。

距离-向量算法中，每个结点仅获得相邻结点所知道的信息，有可能遇到路由环路等问题，并且路由表的更新速度较慢；链路状态路由算法中，每个结点通过广播的方式与其他结点交谈，但它只告诉它们与它直接相连的链路的费用，每个结点都掌握全局的结点拓扑。

### 层次路由
不同自治系统之间进行通信时，为提高效率，引入了层次路由概念：

1. 一个自治系统内部所使用的网络协议称为**内部网关协议（IGP）**，也称为域内路由选择，如 RIP、OSPF 等；
2. 自治系统之间所使用的路由选择协议称为**外部网关协议（EGP）**，也称为域间路由协议，如 BGP 。

当使用层次路由协议时，OSPF 将一个自治系统再划分为若干个区域（Area），每个路由器都知道在本区域内如何把分组路由到目的地，但不知道其他区域的内部结构。因此 OSPF 协议能够用于规模很大的自治系统中。

## IPv4

### IPv4 分组

![IP分组](/Net/IP分组.jpg)

1. **版本**  : 有 4（IPv4）和 6（IPv6）两个值；
2. **首部长度**  : 占 4 位，因此最大值为 15。值为 1 表示的是 1 个 32 位字的长度，也就是 4B 。因为首部固定长度为 20 字节，因此该值最小为 5。如果可选字段的长度不是 4 字节的整数倍，就用尾部的填充部分来填充。
3. **区分服务**  : 用来获得更好的服务，一般情况下不使用。
4. **总长度**  : 占 16 位。单位是 1B ，因此数据报最大长度为 65535B 。包括首部长度和数据部分长度。
5. **标识**  : 占 16 位。它是一个计数器，每产生一个数据报就加 1 。在数据报长度过长从而发生分片的情况下，相同数据报的不同分片具有相同的标识符。
6. **标志**  : 占 3 位。最低为 MF 为 1 时表示后面还有分片；中间位 DF 为 0 时才可以分片。
7. **片偏移**  : 占 13 位。和标识符一起，用于发生分片的情况。片偏移指某片在原分组中的相对位置，单位为 8 字节。
8. **生存时间 TTL**  ：占 8 位。它的存在是为了防止无法交付的数据报在互联网中不断兜圈子。以路由器跳数为单位，每次转发前减 1 ，当 TTL 为 0 时就丢弃数据报。
9. **协议** ：占 8 位。指出携带的数据应该上交给哪个协议进行处理，例如 ICMP、TCP（值为 6）、UDP（值为 17）等。
10. **首部检验和** ：占 16 位。只检验分组首部，而不校验数据部分。因为数据报每经过一个路由器，都要重新计算检验和，因此检验和不包含数据部分可以减少计算的工作量。

一些常见协议的协议字段值：

协议字段值|	协议名|	缩写
--|--|--
1|	互联网控制消息协议|	ICMP
2|	互联网组管理协议|	IGMP
6|	传输控制协议	|TCP
17|	用户数据报协议	|UDP
41|	IPv6封装	|ENCAP
89|	开放式最短路径优先|	OSPF
132|	流控制传输协议|	SCTP

IP 分片示意：

![IP 分片](/Net/ip分片.png)

### IPv4 地址与 NAT
#### IPv4 地址
IP 地址由两部分组成，网络号和主机号，即 `IP 地址 ::= {< 网络号 >, < 主机号 >}`。其中不同分类（A ~ E 五类）具有不同的网络号长度，并且是固定的。

![ip分类](/Net/ip分类.png)

一些特殊的 IP 地址（不用做主机的 IP 地址）：

- 主机号全为 0 表示网络本身；
- 主号号全为 1 表示本网络的广播地址（直接广播地址）；
- 127.0.0.0 表示任意主机本身，用于环路检测，不会出现在任何网络上；
- 0.0.0.0 表示本网络上的本主机；
- 255.255.255.255 表示整个 TCP/IP 网络的广播地址（受限广播地址）。实际上由于路由器对广播域的隔离，255.255.255.255 等效为本网络的广播地址。

#### 网络地址转换

由于 IP 地址的紧缺，一个机构能申请到的 IP 地址数往往远小于本机构所拥有的主机数。并且一个机构并不需要把所有的主机接入到外部的互联网中，机构内的计算机可以使用仅在本机构有效的 IP 地址（专用地址）。

为了网络安全，划出了部分 IP 地址位私有 IP 地址，私有 IP 地址只用于 LAN ，不用于 WAN 连接。当专用网内部的主机使用本地 IP 地址、又想和互联网上的主机通信时，可以使用 NAT（Network Address Translation） 来将本地 IP 转换为全球 IP。

在以前，NAT 将本地 IP 和全球 IP 一一对应，这种方式下拥有 n 个全球 IP 地址的专用网内最多只可以同时有 n 台主机接入互联网。为了更有效地利用全球 IP 地址，现在常用的 NAT 转换表把传输层的端口号也用上了，使得多个专用网内部的主机共用一个全球 IP 地址。使用端口号的 NAT 也叫做网络地址与端口转换 NAPT。由于 NAT 路由器需要对端口进行操作，所以它工作在传输层。

私有 IP 地址有三个专用网段：

- A 类：1 个网段，为 10.0.0.0 \~ 10.255.255.255
- B 类：16 个网段，为 172.16.0.0 \~ 172.31.255.255
- C 类：256 个网段，为 192.168.0.0 \~ 192.168.255.255

### 子网划分与子网掩码、CIDR
#### 子网划分

通过在主机号字段中拿一部分作为子网号，把两级 IP 地址划分为三级 IP 地址： `IP 地址 ::= {< 网络号 >, < 子网号 >, < 主机号 >}`

#### 子网掩码
子网掩码是一种用来指明一个 IP 地址的哪些位标识的是主机所在的网络地址以及哪些位标识的是主机地址的位掩码。

要使用子网，必须配置子网掩码。一个 B 类地址的默认子网掩码为 255.255.0.0，如果 B 类地址的子网占两个比特，那么子网掩码为 11111111 11111111 11000000 00000000，也就是 255.255.192.0。

注意，外部网络看不到子网的存在。

#### 无分类编址 CIDR

无分类编址 CIDR 消除了传统 A 类、B 类和 C 类地址以及划分子网的概念，使用网络前缀和主机号来对 IP 地址进行编码，网络前缀的长度可以根据需要变化： `IP 地址 ::= {< 网络前缀号 >, < 主机号 >}`

CIDR 的记法上采用在 IP 地址后面加上网络前缀长度的方法，即“斜线记法”（CIDR 记法）。例如 128.14.35.7/20 表示前 20 位为网络前缀。

CIDR 的另一个好处是可以进行前缀路由聚合。这种通过使用网络前缀来减少路由表项的方式称为 **路由聚合**，也称为  **构成超网** 。

在路由表中的项目由“网络前缀”和“下一跳地址”组成，在查找时可能会得到不止一个匹配结果，应当采用 **最长前缀匹配**（最佳匹配）来确定应该匹配哪一个。


### ARP 协议、DHCP 协议与 ICMP协议
#### IP 地址与硬件地址
网络分层的原则：每一层独立于其他层完成自己的工作，而不需要相互依赖，上下层之间通过标准接口来互相通信，简单易用又具有扩展性。

以太网位于数据链路层，它是一种多路访问网络，换句话说：一个广播帧发出去，这个广播域里任何一台主机都可以接收。以太网必须有自己的MAC地址，以方便在数据链路层来标示自己的唯一存在。

一般以太网通信有这么几种方式：

1. unicast：A 与 B 互相知道 IP 地址，通过 ARP 获取 IP 与 MAC 地址的映射关系，进而通信；
2. multicast：既然IP层有组播地址，比如 239.1.1.1，那二层也要有对应的MAC地址：`01:00:5e + 组播IP低23位 = 01:00:5e:01:01:01` 。注意 224.1.1.1，225.1.1.1 … 239.1.1.1 所对应的MAC 都为 01:00:5e:01:01:01 ，这是历史原因造成的，因为申请组播MAC地址时，IANA只给了23位；
3. broadcast：
    - IP层的广播地址为：255.255.255.255
    - 以太网对应的MAC： FF:FF:FF:FF:FF:FF

第二层的 MAC 地址，第三层的 IP 地址，第四层的 Port Number 提供了三次筛子（filter）机会：
- 第一个筛子：如果不是本机的 MAC 地址、也没有匹配到组播 MAC ，也不是广播地址，则网卡拒绝接收。否则进入第二个筛子；
- 第二个筛子：依据 Unicast / Multicast / Broadcast 做出判断：
    - Unicast：
        - 匹配本地 IP ，依据协议号提交给 TCP/UDP ，则进入第三个筛子；
        - 没有匹配，查询路由表，找到下一跳，发送出去；
    - Multicast：提交给已注册加入该 multicast group 的进程；
    - Broadcast：提交给已注册接收 broadcast 的进程；
- 第三个筛子：依据 Port Number 将数据提交给特定的进程。

#### 地址解析协议 ARP
ARP（Address Resolution Protocol）实现由 IP 地址得到 MAC 地址。每个主机都有一个 ARP 高速缓存，里面有本局域网上的各主机和路由器的 IP 地址到 MAC 地址的映射表。

ARP 工作在网络层，如果主机 A 知道主机 B 的 IP 地址，但是 ARP 高速缓存中没有该 IP 地址到 MAC 地址的映射，此时主机 A 通过广播（MAC 地址为 FF-FF-FF-FF-FF-FF）的方式发送 ARP 请求分组，主机 B 收到该请求后会发送 ARP 响应分组给主机 A 告知其 MAC 地址，随后主机 A 向其高速缓存中写入主机 B 的 IP 地址到 MAC 地址的映射。

ARP 包括 主机到主机（网络内）、主机到主机（网络间）、路由器到路由器（网络间）、路由器到主机（网络间）四种。由于路由器互联多个网络，因此它不仅有多个 IP 地址，也有多个硬件地址。

#### 动态主机配置协议 DHCP
动态主机配置协议 DHCP（Dynamic Host Configuration Protocol）常用于给主机动态分配 IP 地址，它是基于 UDP 的应用层协议。它使用客户/服务器模式，需要 IP 地址的主机向 DHCP 服务器广播发送 发现报文，只有 DHCP 服务器可以恢复该广播报文，该回答报文叫做 提供报文。流程如下：

1. **DHCP 发现（DISCOVER）**：客户在发送广播来寻找可用的服务器，该客户实现生成一个目的地址为 255.255.255.255 或者一个子网广播地址的 UDP 包；
2. **DHCP 提供（OFFER）**：当 DHCP 服务器收到一个来自客户的 IP 租约请求时，它会提供一个 IP 租约。DHCP为客户保留一个 IP 地址，然后通过网络单播一个“ DHCP 提供”消息给客户。该消息包含客户的 MAC 地址、服务器提供的 IP 地址、子网掩码、租期以及提供 IP 的 DHCP 服务器的 IP；
3. **DHCP 请求（REQUEST）**：当客户PC收到一个IP租约提供时，它必须告诉所有其他的DHCP服务器它已经接受了一个租约提供。因此，该客户会发送一个“DHCP 请求”消息，其中包含提供租约的服务器的 IP。当其他DHCP服务器收到了该消息后，它们会收回所有可能已提供给客户的租约。然后它们把曾经给客户保留的那个地址重新放回到可用地址池中；
4. **DHCP 确认（Acknowledge，ACK）**：当 DHCP 服务器收到来自客户的 REQUEST 消息后，它会发送一个“DHCP 确认”给客户；
5. **DHCP 释放 （RELEASE）**：客户端向 DHCP 服务器发送一个请求以释放 DHCP 资源，并注销其 IP 地址。

#### 网际控制报文协议 ICMP

ICMP（Internet Control Message Protocol）是为了更有效地转发 IP 数据报和提高交付成功的机会。它封装在 IP 数据报中，是 IP 层的协议。

ICMP 报文分为差错报告报文和 ICMP 询问报文：

![ICMP报文](/Net/ICMP报文.png)

ICMP 的两个常见应用：
- Ping（探测主机间的连通性）：它工作在应用层，原理是通过向目的主机发送 ICMP Echo 请求报文，目的主机收到之后会发送 Echo 回答报文。Ping 会根据时间和成功响应的次数估算出数据包往返时间以及丢包率；
- Traceroute（用来跟踪一个分组从源点到终点的路径）：它工作在网络层，Windows 中为 tracert 。Traceroute 发送的 IP 数据报封装的是无法交付的 UDP 用户数据报，并由目的主机发送终点不可达差错报告报文：
    - 源主机向目的主机发送一连串的 IP 数据报。第一个数据报 P1 的生存时间 TTL 设置为 1，当 P1 到达路径上的第一个路由器 R1 时，R1 收下它并把 TTL 减 1，此时 TTL 等于 0，R1 就把 P1 丢弃，并向源主机发送一个 ICMP 时间超过差错报告报文；
    - 源主机接着发送第二个数据报 P2，并把 TTL 设置为 2。P2 先到达 R1，R1 收下后把 TTL 减 1 再转发给 R2，R2 收下后也把 TTL 减 1，由于此时 TTL 等于 0，R2 就丢弃 P2，并向源主机发送一个 ICMP 时间超过差错报文；
    - 不断执行这样的步骤，直到最后一个数据报刚刚到达目的主机，主机不转发数据报，也不把 TTL 值减 1。但是因为数据报封装的是无法交付的 UDP，因此目的主机要向源主机发送 ICMP 终点不可达差错报告报文；
    - 之后源主机知道了到达目的主机所经过的路由器 IP 地址以及到达每个路由器的往返时间；
- 其中 Ping 使用了 CIMP 回送请求和回答报文，tracert 使用了 ICMP 时间超过报文。

## IPv6
### IPv6 的主要特点
描述|	IPv4|	IPv6
---|---|---
地址|	32 位（4B），网络号+主机号| 128 位（16B），网络 64 位，主机 64 位。通常主机部分将派生自 MAC 地址或其他接口标识
地址掩码|	用于从主机部分指定网络|未使用（参地址前缀）
地址前缀|有时用于从主机部分指定网络。有时根据地址的表示格式写为 /nn 后缀|用于指定地址的子网前缀。按照打印格式写为 /nnn（0 <= nnn <= 128）后缀
地址解析协议（ARP）|使用 ARP 来查找与 IPv4 地址相关联的物理地址（如 MAC 或链路地址）|	IPv6 使用因特网控制报文协议版本 6（ICMPv6）将这些功能嵌入到 IP 自身作为无状态自动配置和邻节点发现算法的一部分,不存在 ARP6
地址类型|单点广播地址、多点广播地址和广播地址。|单点广播地址、多点广播地址和任意广播地址

另外，IPv6 不允许在路由器上进行分片（只能在源节点发送前分片），并且加入了身份验证、保密传输等关键特性。与 v4相比，v6 具有长的多的地址，简化了 IP 分组头，并具有更好的支持选项。

### IPv6 地址
IPv6地址可分为三种（除了特殊地址）：
1. 单播（unicast）地址：标示一个网络接口，即传统的点到点通信；
2. 任播（anycast）地址：Anycast 是 IPv6 特有的数据发送方式，Anycast 会有一组接收节点的地址列表，但在数据交付时只会发送给距离最近或发送成本最低（根据路由表来判断）的其中一个接收地址。以当前的应用为例，Anycast 地址只能分配给中间设备（如路由器、三层交换机等），不能分配给终端设备（手机、计算机等），而且不能作为发送端的地址。
3. 多播（multicast）地址：多播地址也称组播地址。它被指定到一群不同的接口，送到多播地址的数据包会被发送到所有的地址。

IPv4 向 IPv6 的过渡阶段可以采用两个策略：
1. 双堆栈（Dual IP stack implementation）：将 IPv6 视为一种 IPv4 的延伸，同时支持IPv4和IPv6，一个实现双堆栈的主机称为“双堆栈主机”。当前大部分IPv6的实现使用双堆栈；
2. 隧道（Tunneling）：将 IPv6 数据报装入 IPv4 的数据部分，实际上就是将IPv4当成IPv6的链接层。

## 路由协议
### 自治系统
互联网可以划分为许多较小的自治系统 AS（Autonomous System），一个 AS 可以使用一种和别的 AS 不同的路由选择协议。

### 域内路由与域间路由
可以把路由选择协议划分为两大类：

- 自治系统内部的路由选择：域内路由选择，使用 **内部网关协议（Interior Gateway Protocol, IGP）**，如 RIP 和 OSPF；
- 自治系统间的路由选择：域间路由选择，使用 **外部网关协议（External Gateway Protocol, EGP）**，如 BGP-4 。

### RIP 路由协议

RIP（Routing Information Protocol） 是一种基于距离向量的路由选择协议。距离是指跳数，直接相连的路由器跳数为 1。跳数最多为 15，超过 15 表示不可达。它是应用层协议，使用 UDP 传输数据，端口号为 520 .

RIP 按固定的时间间隔仅和相邻路由器交换自己的路由表，经过若干次交换之后，所有路由器最终会知道到达本自治系统中任何一个网络的最短距离和下一跳路由器地址。

距离向量算法：

- 对地址为 X 的相邻路由器发来的 RIP 报文，先修改报文中的所有项目，把下一跳字段中的地址改为 X，并把所有的距离字段加 1；
- 对修改后的 RIP 报文中的每一个项目，进行以下步骤：
 - 若原来的路由表中没有目的网络 N，则把该项目添加到路由表中；
 - 否则：若下一跳路由器地址是 X，则把收到的项目替换原来路由表中的项目；否则：若收到的项目中的距离 d 小于路由表中的距离，则进行更新（例如原始路由表项为 Net2, 5, P，新表项为 Net2, 4, X，则更新）；否则什么也不做。
- 若 3 分钟还没有收到相邻路由器的更新路由表，则把该相邻路由器标为不可达，即把距离置为 16。

RIP 协议实现简单，开销小。但是 RIP 能使用的最大距离为 15，限制了网络的规模。并且当网络出现故障时，要经过比较长的时间才能将此消息传送到所有路由器。

### OSPF 路由协议

开放最短路径优先 OSPF（Open Shortest Path First），是为了克服 RIP 的缺点而开发出来的。它使用了 Dijkstra 提出的最短路径算法 SPF。

OSPF 具有以下特点：

- 向本自治系统中的所有路由器发送信息，这种方法是洪泛法；
- 发送的信息就是与相邻路由器的链路状态，链路状态包括与哪些路由器相连以及链路的度量，度量用费用、距离、时延、带宽等来表示；
- 只有当链路状态发生变化时，路由器才会发送信息；
- OSPF 是网络层协议，它直接使用 IP 数据报传送，其 IP 数据报首部协议字段为 89 。

所有路由器都具有全网的拓扑结构图，并且是一致的。相比于 RIP，OSPF 的更新过程收敛的很快。

### 外部网关协议 BGP
BGP（Border Gateway Protocol，边界网关协议）是不同自治系统 AS 之间交换路由信息的协议。AS 之间的路由选择很困难，主要是由于：

- 互联网规模很大；
- 各个 AS 内部使用不同的路由选择协议，无法准确定义路径的度量；
- AS 之间的路由选择必须考虑有关的策略，比如有些 AS 不愿意让其它 AS 经过。

BGP 只能寻找一条比较好的路由（避免兜圈子），而不是最佳路由。BGP 采用 **路径-向量选择协议**（不同于距离-向量选择协议与链路状态协议），是基于 TCP 的应用层协议。每个 AS 都必须配置 BGP 发言人，通过在两个相邻 BGP 发言人之间建立 TCP 连接来交换路由信息：

![BGP与AS](/Net/BGP与AS.png)


## IP 组播
### 组播的概念
组播（multicast，又译作多播、多点发送、多点广播或群播）是指把信息同时传递给一组目的地址。它使用的策略是最高效的，因为消息在每条网络链路上只需传递一次，且只有在链路分叉的时候，消息才会被复制。常规的点到单点传递被称作单播。当以单播的形式把消息传递给多个接收方时，必须向每个接收者都发送一份数据副本。因为非点到点传送数据，所以组播一定是仅应用于 UDP 的。

### IP 组播地址
IP 组播使用 D 类地址，D 类地址不能出现在 IP 数据报的源 IP 地址字段（也就是不能作为组播源地址，换言之，组播源的 IP 地址仍是单播地址）。

以太网传输单播 IP 包的时候，目的 MAC 地址即为接收者的 MAC 地址。但是在传输组播包时，传输目标不再是一个具体的接收者，而是一个成员不确定的组，所以对应也就需要使用组播 MAC 地址作为目的地址。

![组播](/Net/组播.png)

IANA 规定，组播 MAC 地址的高 25 位固定为 `0000 0001 0000 0000 0101 1110 0` ，形成 MAC 地址 25 位前缀，MAC 地址的低 23 位为组播 IPv4 地址的低 23 位。以 IP 地址为 239.1.1.1 的组播为例，它们之间的映射关系即 `01:00:5e + 组播 IP 低 23 位 = 01:00:5e:01:01:01` 。注意 224.1.1.1，225.1.1.1 … 239.1.1.1 （共 32 个）所对应的 MAC 都为 01:00:5e:01:01:01 ，因此收到组播数据报的主机还要在 IP 层利用软件进行过滤。


### IGMP 协议与组播路由算法
网路群组管理协议（Internet Group Management Protocol）是用于管理网路协议多播组成员的一种通信协议。IP 主机和相邻的路由器利用 IGMP 来创建多播组的组成员。像 ICMP 用于单播连接一样，IGMP 也是 IP 多播说明的一个完整部分。

IGMP 协议本质是让组播路由器知道本局域网上是否有主机参加或退出某个组博组。组播路由选择实际上就是找出以源主机为根结点的组播转发树，其中每一个分组在每条链路上只传送一次。


组播第一个挑战就是组播的接收者（Receiver）不知道组播源在哪里，换句话说，就是不知道组播源的IP地址，如果知道了，可以直接向这个IP地址发送加入组播的请求，那一切就简单了，组播可以直接推送到组播的接收者。为了克服这个困难，引入了一个中介机构 RP，Rendezvous Point，即组播的汇聚点。例如：

- Multicast Source IP: 1.1.1.1
- Multicast Group IP : 238.1.1.1
- Rendezvous Point IP: 2.2.2.2
- IGMPv2: Host chat with Router
- PIM Sparse Mode: Router chat with Router

于是组播源就把组播 238.1.1.1 封装在一个单播（source IP 1.1.1.1，destination IP 2.2.2.2) 发给 RP ，我们称之为组播源的单播注册。虽然组播的接收者不知道组播源在哪里，但他们所在的广播域里的路由器一定知道，于是组播接收者用 IGMPv2 发送一个广播请求，这个广播域里的路由器听到了这个广播请求，查询自己的单播路由表，可以知道谁是通向 RP 的上游路由器，然后发送一个 PIM Join 请求给上游，上游路由器按照相同的方式把这种 Join 请求一级一级的中继到 RP，RP 简单地将收到Join请求这个接口放入组播出接口列表（OIL），然后把组播仅仅复制（Replication)一份从OIL发送出去。PIM Join 在层层向上中继的过程，路由器已经形成一个上下游的关系，越是靠近RP的路由器，为上游；而远离RP的路由器，为下游。这其实就是一种树，因为树的根是RP，我们称这种组播树为基于RP的树，即 RP-Based Tree，简称 RPT。

当组播接收者直连的路由器收到第一个组播，就知道组播源在哪里了，于是向组播源 IP 发起了一个新的 PIM Join 请求，以此寻找一条更佳的路径。

## 移动 IP

### 移动 IP 的概念
支持移动性的因特网体系结构与协议统称为移动 IP。传统 IP 地址一方面可以标识唯一的主机，另一方面它还作为主机的地址在数据的路由中起重要作用。但对于移动节点，由于互联网接入点会不断发生变化，所以其 IP 地址在两方面发生分离，一是移动节点需要一种机制来唯一标识自己，另一是需要这种标识不会被用来路由。移动 IP 便是为了能让移动节点能够分离 IP 地址这两方面功能，而又不彻底改变现有互联网的结构而设计。

使用移动 IP 可将 IP 数据报路由到移动节点。无论移动节点连接到何处，移动节点的家乡地址——即 **主地址** ——可始终标识该移动节点。如果移动节点不在家乡网络上，则 **转交地址**（辅地址）将与移动节点的家乡地址相关联。转交地址可提供有关移动节点当前连接点的信息。移动 IP 使用注册机制向家乡代理注册转交地址。

### 移动 IP 通信过程
家乡代理可将数据报从家乡网络重定向到转交地址。家乡代理会构造一个新的包含移动节点转交地址的 IP 数据包头，将其用作目标 IP 地址。这个新的 IP 数据包头用于封装初始 IP 数据报。因此，移动节点的家乡地址不会影响已封装数据报的路由，直到数据报到达转交地址为止。这种类型的封装被称为隧道连接。数据报到达转交地址之后，将对数据报解除封装。然后，将数据报传送到移动节点。

![移动IP](/Net/移动IP.png)

上图显示了已经移到外地网络（网络 B）的移动节点。家乡网络（网络 A）上的家乡代理会拦截发往移动节点的数据报，并对数据报进行封装。然后，数据报会发送到网络 B 上的外地代理。外地代理会去除外部头，然后将数据报传送到位于网络 B 上的移动节点。

移动代理（家乡代理和外地代理）通过使用代理通告消息来通告其是否存在。移动节点也可以选择请求代理通告消息。移动节点可使用通过代理请求消息在本地连接的任何移动代理。移动节点使用代理通告确定移动节点是在家乡网络上还是在外地网络上。

移动节点使用特殊注册过程通知家乡代理有关移动节点的当前位置。移动节点会始终“侦听”移动代理通告以确定移动代理是否存在。移动节点使用这些通告帮助确定移动节点何时移到另一个子网。如果移动节点确定其已移到新位置，则会使用新的外地代理将注册消息转发到家乡代理。移动节点从一个外地网络移到另一个外地网络时，会使用同一过程。

如果移动节点检测到其位于家乡网络上，则移动节点将不使用移动服务。移动节点返回到家乡网络时，会向家乡代理取消注册。

## 网络层设备
### 路由器的功能和组成

路由器从功能上可以划分为：路由选择和分组转发。它隔离了广播域，可以作为最基础的包过滤防火墙应用。

分组转发结构由三个部分组成：交换结构、一组输入端口和一组输出端口

![路由器的结构](/Net/路由器的结构.jpg)


### 路由表与路由转发

- 从数据报的首部提取目的主机的 IP 地址 D，得到目的网络地址 N。
- 若 N 就是与此路由器直接相连的某个网络地址，则进行直接交付；
- 若路由表中有目的地址为 D 的特定主机路由，则把数据报传送给表中所指明的下一跳路由器；
- 若路由表中有到达网络 N 的路由，则把数据报传送给路由表中所指明的下一跳路由器；
- 若路由表中有一个默认路由，则把数据报传送给路由表中所指明的默认路由器；
- 报告转发分组出错。

![路由表与路由转发](/Net/路由表与路由转发.jpg)