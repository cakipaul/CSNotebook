# OSI-数据链路层

## 数据链路层的功能
主要作用是将物理层可能出错的物理连接改造成逻辑上无差错的数据链路，使之对网络层表现为一条无差错的链路。

### 为网络层提供服务
对网络层而言，数据链路层的基本任务是将源机器网络层的数据传输到目标机器的网络层，数据链路层可为网络层提供的服务有：

1. 无确认的无连接服务：源机器发送帧时不需要先建立链路连接，目的机器接收到数据帧时不需要发回确认。适用于实时通信或误码率较低的通信信道，如以太网；
2. 有确认的无连接服务：适用于误码率较高的通信信道，如无线通信；
3. 有确认的面向连接的服务：帧传输过程分为三个阶段：建立数据链路、传输帧、释放数据链路，可靠性高，适用于通信要求可靠性、实时性较高的场合。

### 帧定界、帧同步

将网络层传下来的分组添加首部和尾部，其中包含很多控制信息，用于标记帧的开始和结束，即**帧定界**。而**帧同步**是指接收方应该能从接收到的二进制比特流中区分出帧的起始与终止。如 HDLC 通信规程中，用标志位 F（01111110）来标识帧的开始和结束。

![封装成帧](/Net/hdlc.jpg)

### 透明传输

帧使用首部和尾部进行定界，如果帧的数据部分含有和首部尾部相同的内容，那么帧的开始和结束位置就会被错误的判定。需要在数据部分出现首部尾部相同的内容前面插入转义字符。如果数据部分出现转义字符，那么就在转义字符前面再加个转义字符。在接收端进行处理之后可以还原出原始数据。这个过程透明传输的内容是转义字符，用户察觉不到转义字符的存在。

![透明传输](/Net/透明传输.png)

### 流量控制
流量控制并不是数据链路层特有的功能，许多高层协议中也提供此功能，只是所控制的对象不同而已。对于数据链路层来说，控制的是两个相邻结点之间数据链路上的流量。而对于传输层来说，控制的则是从源端到目的端之间的流量。

### 差错检测

目前数据链路层广泛使用了循环冗余检验（CRC）来检查比特差错。通过自动重传请求（ARQ，Automatic Repeat reQuest）方式来重传出错的帧。数据链路层的定时器和编号机制保障每一帧最终都能有且仅有一次正确地交付给目的结点。


## 组帧
组帧主要解决帧定界、帧同步、透明传输等问题，组帧时既要加首部也要加尾部，因为帧是网络中信息载体的最小单位。而分组（即 IP 数据报）仅仅包含在帧的数据部分，所以不需要加尾部来定界。

### 字符计数法
![字符计数法](/Net/字符计数法.gif)

这种方法最大的问题在于如果标识帧大小的字段出错，即失去了帧边界划分的依据，将造成灾难性的后果。

### 字符填充的首尾定界符法

![字符填充的首尾定界符法](/Net/字符填充的首尾定界符法.gif)

在这种帧同步方式中，为了不使数据信息位中与特定字符相同的字符被误判为帧的首尾定界符，可以在这种数据帧的帧头填充一个转义控制字符（DLE STX，Data Link Escape – Start of Text），在帧的结尾则以DLE ETX（Data Link Escape-End of Text）结束，以示区别，从而达到数据的透明性。

若帧的数据中出现DLE字符，发送方则插入一个“DLE”字符，接收方会删除这个DLE字符。

### 比特填充的首位标志法

"比特填充的首尾界定符法"是以一组特定的比特模式，即 01111110 来标志一帧的起始与终止。它的工作原理是在每一帧的开始和结束位置都加上一个特殊的位模式 01111110 。当发送方的数据链路层中遇到 5 个连续的"1"时，会自动在输出位流中填充一个"0"。在接收方，当收到连续5个"1"，并且后面位是"0"时，自动删除该"0"位。

比特填充帧同步方式很容易由硬件来实现，性能优于字符填充方式。所有面向比特的同步控制协议采用统一的帧格式，不论是数据，还是单独的控制信息均以帧为单位传送，其典型代表是 ISO 的 HDLC 协议。

### 违规编码法
该法在物理层采用特定的比特编码方法时采用。例如，曼彻斯特编码方法，是将数据比特“1”编码成“高—低”电平对，将数据比特“0”编码成“低—高”电平对。而“高—高”电平对和“低—低”电平对在数据比特中是违法的。可以借用这些违法编码序列来界定帧的起始与终止。

局域网IEEE 802标准中就采用了这种方法。违法编码法不需要任何填充技术，便能实现数据的透明性，但它只适于采用冗余编码的特殊编码环境。

由于字节计数法中 Count 字段的脆弱性（其值若有差错将导致灾难性后果）及字符填充实现上的复杂性和不兼容性，目前较普遍使用的帧同步法是比特填充法和违法编码法。

## 差错控制
通信过程中的差错大致可分为两类：一类是由热噪声引起的随机错误;另一类是由冲突噪声引起的突发错误。突发性错误影响局部，而随机性错误影响全局。

自动请示重发ARQ和前向纠错FEC是进行差错控制的两种方法：

- ARQ（Atuomatic Retransmission reQuest）：接收端检测出有差错时，就设法通知发送端重发，直到正确的码字收到为止。ARQ方式使用检错码，但必须有双向信道才可能将差错信息反馈到发送端。同时，发送方要设置数据缓冲区，用以存放已发出的数据以便于重发出错的数据。
- FEC（Forward Error Correction）：接收端不但能发现差错，而且能确定二进制码元发生错误的位置，从而加以纠正。FEC方式使用纠错码，不需要反向信道来传递请示重发的信息，发送端也不需要存放以务重发的数据缓冲区。但编码效率低，纠错设备也比较复杂。

### 检错编码
一般的检错码有：奇偶校验码、循环冗余码。

1. 奇偶校验码： 一种增加二进制传输系统最小距离的简单和广泛采用的方法。是一种通过增加冗余位使得码字中"1"的个数恒为奇数或偶数的编码方法，它是一种检错码。在实际使用时又可分为垂直奇偶校验、水平奇偶校验和水平垂直奇偶校验等几种。
    1. 垂直奇偶校验：能检测出每列中的所有奇数位错,但检测不出偶数位的错。对于突发错误来说,奇数位错与偶数位错的发生概率接近于相等,因而对差错的漏检率接近于1/2；
    2. 水平奇偶校验：漏检率比垂直奇偶校验方法低。但是实现水平奇偶校验码时，不论是采用硬件还是软件方法，都不能在发送过程中产生奇偶校验冗余位边插入发送,而必须等待要发送的全部信息块到齐后,才能计算冗余位,也就是一定.要使用数据缓冲器,因此它的编码和检测实现起来都要复杂一些；
    3. 水平垂直奇偶校验：能检测出所有3位或3位以下的错误(因为此时至少在某一行或某一列上有一位错)、奇数位错、大部分突发错以及很大一部分偶数位错。测量表明,这种方式的编码可使误码率降至原误码率的百分之一到万分之一。水平垂直奇偶校验不仅可检错,还可用来纠正部分差错。
2. 循环冗余码（CRC，Cyclic Redundancy Code）：数据通信领域中最常用的一种差错校验码，其特征是信息字段和校验字段的长度可以任意选定。

    ![CRC校验码](/Net/CRC校验码.jpg)

    设待发送数据 M 为 10110011（m = 8），标准多项式为 11001（r = 4），按照模 2 除法运算（各位异或操作），余数 FCS（帧检验序列） = 0100，所以发送出去的数据为 10110011 0100（即 2^r * M + FCS），共 m + r 位。

### 纠错编码
纠错编码又称之为信道编码，最常见的纠错编码为汉明码（也作海明码，Hamming Code），是在电信领域的一种线性调试码。汉明码在传输的消息流中插入验证码，当计算机存储或移动数据时，可能会产生数据位错误，以侦测并更正单一比特错误。由于汉明编码简单，它们被广泛应用于内存（RAM）。要注意的是，汉明码只能修正一位错误，发现两位错误，对两位以上的错误不能保证正确发现。

汉明码的实现原则是在原来 n 位的数据中插入 k 位数据作为校验位，变为 m = n + k 位编码。

![汉明码](/Net/汉明码.jpg)

## 流量控制与可靠传输机制

### 流量控制、可靠传输与滑动窗口机制

#### 停止-等待流量控制基本原理
发送方每发送一帧，都要等待接收方的应答信号，之后才能发送下一帧；接收方每接受一帧，都要反馈一个应答信号，表示可接受下一帧，如果接收方不反馈应答信号，则发送方必须一直等待。每次只允许发送一帧，然后就陷入等待接收方确认信息的过程中，因而传输效率很低。

#### 滑动窗口流量控制基本原理
在任意时刻，发送方都维持一组连续的允许发送的帧的序号，称为**发送窗口**；同时接收方也维持一组连续的允许接收帧的序号，称为**接收窗口**。发送窗口用来对发送方进行流量控制，而发送窗口的大小 Wt 代表在还没有收到对方确认信息的情况下发送方最多还可以发送多少个数据帧。同理，在接收端设置接收窗口是为了控制可以接收哪些数据帧而不可以接收哪些数据帧。在接受数据方只有当收到的数据帧的序号落入接受窗口内才允许将该数据帧收下。若接受到的数据帧落在接受窗口之外，则一律将其丢弃。

在发送端，每收到一个确认帧，发送窗口就向前滑动一个帧的位置，当发送窗口内没有可以发送的帧（即窗口内的帧全部是已发送但未收到确认的帧），发送方就会停止发送，直到收到接受方发送的确认帧使窗口移动，窗口内有可以发送的帧，之后才开始继续发送。

在接受端，当收到数据帧后，将窗口向前移一个位置，并发回确认帧，若收到的数据帧落在接受窗口之外则一律丢弃。

滑动窗口有以下重要特性：

1. 只有接受窗口向前滑动时（同时接受方发送确认帧），发送窗口才有可能（只有发送方收到确认帧才是一定）向前滑动;
2. 从滑动窗口的概念看，停止-等待协议、后退N帧协议和选择重传协议只有在发送窗口大小和接受窗口大小有所差别:
    1. 停止-等待协议：发送窗口大小 = 1，接受窗口大小 = 1；
    2. 后退N帧协议：发送窗口大小 > 1，接受窗口大小 = 1；
    3. 后退N帧协议：发送窗口大小 > 1，接受窗口大小 > 1；
3. 当接受窗口的大小为1时，可保证帧的有序接受;
4. 数据链路层的滑动窗口协议中，窗口的大小在传输过程中是固定的。

#### 可靠传输机制

数据链路层的可靠传输通常使用**确认**和**超时重传**两种机制来完成。

确认是一种无数据的控制帧，这种控制帧使得接收方可以让发送方知道哪些内容被正确接收。有些情况下为了提高传输效率，将确认捎带在一个回复帧中，称为捎带确认。

超时重传是指发送方在发送某一个数据帧以后就开始一个计时器，在一定时间内如果没有得到发送的数据帧的确认帧，那么就重新发送该数据帧，直到发送成功为止。

自动重传请求（Auto Repeat reQuest，ARQ），通过接收方请求发送方重传出错的数据帧来恢复出错的帧，是通信中用于处理信道所带来差错的方法之一。传统自动重传请求分为三种，即停等式（Stop-and-Wait）ARQ、后退N帧（Go-Back-N）ARQ 以及选择性重传（Selective Repeat）ARQ。后两种协议是滑动窗口技术与请求重发技术的结合，由于窗口尺寸开到足够大，帧在线路上可以连续地流动，因此又称为连续ARQ协议。


### 单帧滑动窗口与停止-等待协议

在停止等待协议中，源站发送单个帧后必须等待确认，在目的站的回答到达源站之前，源站不能发送其他的数据帧。从滑动窗口机制的角度看，停止等待协议相当于发送窗口和接受窗口的接受窗口大小均为1的滑动窗口协议。

在停止等待协议中，除了数据帧丢失，还可能出现以下两种差错：

1. 到达目的站的帧可能已遭破坏，接受站利用在前面讨论过的差错检测技术检出后，简单地将该帧丢弃。为了对付这种可能发生的情况，源站装备了计时器，在一个帧发送之后，源站等待确认，如果在计时器计满时仍未收到确认，则再次发送同样的帧。如此重复，直到该数据帧无错误地到达为止。

2. 另一个可能的差错是数据帧正确而确认被破坏。为了避免这样的问题，发送的帧交替地用0和1来标识，肯定确认则分别用ACK0和ACK1来表示，当收到的确认有误时，则重传已发送的帧。下面分析停止等待协议的实现步骤。

![单帧滑动窗口与停止等待协议](/Net/单帧滑动窗口与停止等待协议.jpg)

**在发送结点：**
```c
1. 从主机取一个数据帧，送交发送缓冲;
2. V(S) = 0; //发送状态V(S)初始化
3. N(S) = V(S); //将发送状态变量值写入数据帧的发送序列号 N(s)
4. 将发送缓存中的数据帧发送出去; //这个数据帧的副本仍保留在发送缓存中
5. 设置超时计时器; //选择适当的超时重传时间 Tout
6. while(1){
    if(收到确认帧 ACK(n) ){
        if( n = 1 - V(S) ){ //已发送的数据帧被接收方确认
            从主机取一个新的数据帧，放入发送缓存；
            V(S) = 1 - V(S);
            转到 4; //更新发送状态变量，变为下一个序号
        }
        else{
            丢弃这个确认帧; //这说明已发送的数据帧没有被接收方确认
        }
    }
    if(超时计数器时间到) 转到 4; //重传已发送的数据帧
}
```
**在接受结点：**
```c
1. V(R) = 0; //接受状态变量初始化，其数值等于欲接受的数据帧的发送序列
2. while(1){
    if(收到一个数据帧 && 没有产生传输差错){ //出错则重新等待接受新帧
        if(N(S) = V(R)) {
            将收到的数据帧中的数据部分送交主机;
            V(R) = 1 - V(R); //更新接受状态变量，准备接受下一个数据帧
            发送确认帧 ACK(n); //n = V(R)，表明期望收到V(R)
        }
        else{ //即丢弃重复帧
            发送确认帧 ACK(n);
        }
    }
}
```
由以上算法可知，对于停止-等待协议，由于每发送一个数据帧就停止并等待，因此用 1bit 编号就够。在停止-等待协议中，若连续出现相同发送序号的数据帧，表明发送端进行了超时重传。连续出现相同序号的确认帧，表明接收端收到了重复帧。

此外，为了超时重发和判定重复帧的需要，发送方和接受方都需设置一个帧缓冲区。发送端在发送完数据帧时，必须在其发送缓存中保留此数据帧的副本，这样才能在出差错时进行重传。只有在收到对方发来的确认帧 ACK 时，方可清除此副本。


### 多帧滑动窗口与后退 N 帧协议（GBN, GO-BACK-N）

![后退 N 帧协议](/Net/后退N帧协议.gif)

在 GBN 式 ARQ 中，发送方不需要在收到上一帧的 ACK 后才能开始发送下一帧，而是可以连续发送帧。当接受方检测出失序的信息帧后，要求发送方重发最后一个正确接受的信息帧之后的所有未确认的帧；或者当发送方发送了 N 个帧后，若发现该 N 个帧的前一个帧在计时器超时后仍未返回其确认信息，则该帧被判为出错或丢失，此时发送方就不得不又重传该出错帧及随后的 N 个帧。换句话说，接受帧只允许按顺序接受帧。

为了减少开销，GBN 协议还规定接受端不一定每收到一个正确帧就必须发回一个确认帧，而是可以在连续收到好几个正确的确认帧后，才对最后一个数据帧发确认信息，或者可以在自己有数据要发送时才将对以前正确收到的帧加以捎带确认。

后退 N 帧协议的接受窗口为 1，可以保证按序接受数据帧。若采用 n 个比特对帧编号，则其发送窗口的尺寸 Wt 应满足：`1 ≤ Wt ≤ 2^n-1`。若发送窗口的尺寸大于 2^n-1，则会造成接受方无法分辨新帧和旧帧。

后退 N 帧协议一方面因连续发送数据帧而提高了信道的利用率，但另一方面，在重传时又必须把原来已发送正确的数据帧进行重传，这种做法又使传送速率降低。若信道的传输质量很差导致误码率较大时，后退 N 帧协议不一定优于停止等待协议。

### 多帧滑动窗口与选择重传协议（SR, Selective Repeat）
为了进一步提高信道的利用率，可加大接受窗口，以便先收下发送序号不连续但仍处在接受窗口中的那些数据帧。等到所缺序号的数据帧收到后再一并送交主机。这就是选择重传 ARQ 协议。

在选择重传协议中，每一个发送缓冲区对应一个计时器，当计时器超时时，缓冲区的帧就会重传。另外该协议使用了比上述其他协议更有效的差错处理策略，即一旦接收方怀疑帧出错，就会发送一个否定帧 NAK 给发送方，要求发送方对 NAK 中指定的帧进行重传。

选择重传协议的接受窗口尺寸 Wr 和发送窗口尺寸 Wt 都大于1，一次可以发送或接受多个帧。若采用 n 比特对帧编号，为了保证接收方向向前移动窗口后，新窗口序号与旧窗口序号没有重叠部分，需要满足条件：`接受窗口 Wr + 发送窗口 Wt ≤ 2^n`。假定仍然采用累计确认的方法，并且接受窗口 Wr 显然不应超过发送窗口 Wt(否则无意义)，那么接受窗口尺寸不应超过序号范围的一半 `Wr ≤ 2^(n-1)`。当接受窗口为最大值时，`Wtmax = Wrmax = 2^(n-1)`。一般情况下，SR 协议中 Wr 与 Ws 窗口大小是相同的。

选择重传协议可以避免重复传送那些本已正确到达接收端的数据帧，但在接收端要设置具有相当容量的缓冲区来暂存那些未按序正确收到的帧。接受端不能接受窗口以下或窗口上界以上的序号的帧，因此所需缓冲区的数目等于窗口的大小，而不是序号数目。

## 介质访问控制

1. 广播信道：一对多通信，一个节点发送的数据能够被广播信道上所有的节点接收到。所有的节点都在同一个广播信道上发送数据，因此需要有专门的控制方法进行协调，避免发生冲突（冲突也叫碰撞）。主要有两种控制方法进行协调，一个是使用信道复用技术，一是使用 CSMA/CD 协议；
2. 点对点信道：一对一通信，不会发生碰撞，因此也比较简单，使用 PPP 协议进行控制。

介质访问控制所要完成的主要任务是为使用介质的每个结点隔离来自同一信道上其他结点所传送的信号，以协调活动结点的传输。用来决定广播信道中信道分配的协议属于数据链路层的一个子层，称为介质访问控制（Medium Access Control，MAC）子层。MAC 地址是链路层地址，长度为 6 字节（48 位），用于唯一标识网络适配器（网卡）。

网卡（网络接口卡/网络适配器 NIC,Network Interface Card/Adapter）上装有处理器和储存器，是工作在数据链路层的设备。另外网卡也控制着主机对介质的访问，因此网卡也工作在物理层。

一台主机拥有多少个网络适配器就有多少个 MAC 地址。例如笔记本电脑普遍存在无线网络适配器和有线网络适配器，因此就有两个 MAC 地址。

常见的介质访问控制方法：
1. 静态划分信道：**信道划分**介质访问控制；
2. 动态分配信道：**随机访问**介质访问控制和**轮询访问**介质访问控制。

### 信道划分介质访问控制

信道划分介质访问控制将使用介质的每个设备与来自同一通信信道上的其他设备的通信隔离开来，把时域和频域资源合理地分配给网络上的设备。

多路复用技术：在一条介质上同时携带多个传输信号，把多个信号组合在一条物理信道上进行传输，使多个计算机或终端设备共享设备资源，提高信道的利用率。

1. 频分多路复用（FDM）：将一种将多路基带信号调制到不同频率载波上再叠加形成一个复合信号的多路复用技术。在实际应用中，为了防止子信道之间的干扰，相邻信道之间需要加入“保护频带”。充分利用了传输介质的带宽，系统效率高，由于技术比较成熟，实现也较容易。

2. 时分多路复用（TDM）：将一条物理信道按时间分成若干个时间片，轮流地分配给多个信号使用。由于计算机数据的突发性，一个用户对已经分配到的子信道的利用率一般不高。统计时分多路复用（STDM，又称异步时分多路复用）是 TDM 的一种改进，它采用 STDM 帧，STDM 帧不是固定分配时隙，而是按需动态地分配时隙，当终端有数据要传送时才会分配到时间片，因此可以提高线路的利用率。例如，线路传输速率为8000b/s,4个用户的平均速率都为2000b/s，当采用 TDM 方式时，每个用户的最高速率为2000b/s,而在STDM方式下，每个用户最高速率可达8000b/s。

3. 波分多路复用（WDM）：波分多路复用就是光的频分多路复用，相似一根光纤中传输多种不同波长（频率）的光信号，由于波长（频率）不同，所以各路光信号互不干扰，最后再用波分复用器将多路波长分解出来。由于光波处于频谱的高频段，有很高的带宽，因而可以实现很多路的波分复用。

4. 码分多路复用（CDM）：码分多路复用是靠不同的编码来区分各路原始信号的一种复用方式。码分多址（code division mutiple access ,CDMA）是码分复用的一种方式，其原理是每比特时间分成 m 个更短的时间槽，称为芯片（Chip）,通常情况下每比特有 64 或 128 个芯片。每个站点被指定一个唯一的 m 位的代码或芯片序列。当发送 1 时站点就发送芯片序列，当发送 0 时就发送芯片序列的反码。当两个或多个站点同时发送时，各路数据在信道中被线性相加。为了从信道中分离出各路信号，要求各个站点的芯片序列是相互正交的。

    令向量 **S** 表示 A 站的码元向量，令 **T** 表示其他任何站的码元向量。两个不同站的码元序列正交，就是向量 **S** 和 **T** 的规格化内积都是0：

    $$ \bold{S}*\bold{T}=\frac{1}{m}\sum_{i=1}^mS_iT_i=0 $$

    任何一个码片向量和该码片向量自己的规格化内积都是 1，任何一个码片向量和该码片反码的向量的规格化内积值是 -1：

    $$ \bold{S}*\bold{S}=\frac{1}{m}\sum_{i=1}^mS_iS_i=\frac{1}{m}\sum_{i=1}^m(\pm1)^2=1 $$

    码分多路复用技术具有频谱利用率高、抗干扰能力强、保密性强、语音质量好等优点，还可以减少投资和降低运行成本，主要用于无线通信系统，特别是移动通信系统。

### 随机访问介质访问控制
#### ALOHA 协议
ALOHA 是 Additive Link On-line HAwaii system 的缩写。它分为纯 ALOHA 和时隙 ALOHA 两种：

1. 纯ALOHA协议(Pure ALOHA)：当传输点有数据需要传送的时候，它会立即向通讯频道传送。接收点在收到数据后，会回复 ACK 给传输点。如果接收的数据有错误，接收点会向传输点发送 NACK。当网络上的两个传输点同时向频道传输数据的时候，会发生冲突，这种情况下，两个点都停止一段时间后，再次尝试传送。

2. 分段（或时隙）ALOHA协议(Slotted ALOHA)：这是对纯ALOHA协议的一个改进，思想是用时钟来统一用户的数据发送。改进之处在于，它把频道在时间上分段，每个传输点只能在一个分段的开始处进行传送。用户每次必须等到下一个时间片才能开始发送数据，每次传送的数据必须少于或者等于一个频道的一个时间分段。这样很大的减少了传输频道的冲突。从而避免了用户发送数据的随意性，减少了数据产生冲突的可能性，提高了信道的利用率。

#### CSMA 协议
Carrier Sense Multiple Access（载波侦听多路访问）是争用型的介质访问控制协议，位于数据链路层。与 ALOHA 协议相比，CSMA 协议多了一个载波侦听装置。

1. 1-坚持 CSMA (1-persistent CSMA)：当信道忙或发生冲突时，要发送帧的站，不断持续侦听，一有空闲，便可发送。其中，长的传播延迟和同时发送帧，会导致多次冲突，降低系统性能；
2. 非持续 CSMA：在要发送数据时侦听信道，若为空闲则马上发送数据；若信道被占用，则等待随机的一段时间，然后重复上述过程。它有更好的信道利用率，但导致更长延迟；
3. p-持续 CSMA：它应用于时分信道，在要发送数据时侦听信道，若为空闲则按照 P 概率发送帧。即信道空闲时，有 P 概率发送，Q = 1 - P 概率不发送。若不发送，下一时槽仍空闲，同理进行侦听。

#### CSMA/CD 协议
CSMA/CD（Carrier Sense Multiple Access/Collision Detection），即载波监听多路访问/冲突检测方法。它一旦检测到冲突，立即终止当前传输中的帧，节省时间和带宽，并等待一段时间，重新尝试。它广泛用于 LAN 中 MAC 子层,是当前以太网 LAN 的基础。该网络只能进行半双工通信。

-  **多点接入** ：总线型网络，许多主机以多点的方式连接到总线上。
-  **载波监听** ：每个主机都必须不停地监听信道。在发送前，如果监听到信道正在使用，就必须等待。
-  **碰撞检测** ：在发送中，如果监听到信道已有其它主机正在发送数据，就表示发生了碰撞。虽然每个主机在发送数据之前都已经监听到信道为空闲，但是由于电磁波的传播时延的存在，还是有可能会发生碰撞。

其工作方式可总结为：**“先听后发，边听边发（区别于 CSMA 协议），冲突停发，随即重发”**。

记端到端的传播时延为 τ，最先发送的站点最多经过 2τ 就可以知道是否发生了碰撞，称 2τ 为  **争用期（冲突窗口/碰撞窗口）** 。只有经过争用期之后还没有检测到碰撞，才能肯定这次发送不会发生碰撞。

以太网规定 51.2μs 为争用期长度，对于 10Mb/s 的以太网，在征用期可发送 512bit，即 64B .因此以太网规定最短帧长为 64B ，凡小于 64 B的都是由于冲突而异常中止的无效帧。小于 64B 的正常帧会在后面加入一个整数字节的填充字段。


当发生碰撞时，站点要停止发送，等待一段时间再发送。这个时间采用  **截断二进制指数退避算法**  来确定：
    
    1. 确定基本退避时间，一般采用争用期时长;
    2. 定义参数 k，等于min(重传次数,10);
    3. 从离散的整数集合 {0, 1, .., 2^k-1} 中随机取出一个数，记作 r，然后取 r 倍的基本退避时间作为重传等待时间;
    4. 当重传达到 16 次仍不成功时，则认为网络过于拥挤，抛弃此帧并向高层报错;

#### CSMA/CA 协议
CSMA/CA(Carrier Sense multiple Access/Collision Avoidance)，即载波监听多路访问/冲突避免。在 802.11 无线局域网协议中，无线传输信号的性质决定了无线信道接收与发送信号时，无法采用 CSMA/CD 通过电压变化检测冲突的方法，同时无线网络中存在隐蔽站与暴露站的问题，因此设计了 CSMA/CA 来完成无线局域网下的冲突检测和避免。其基本思想是在发送数据前广播告知其他结点不要发送数据，预防发生碰撞。

CSMA/CA 使用预约信道、ACK 帧、RTS/CTS三种机制来实现碰撞避免：
1. 预约信道：发送方在发送数据的同时向其他站点通知自己传输数据所需时长，以避免碰撞；
2. ACK 帧：所有站点在正确收到数据帧后都要返回一个 ACK 帧，如果接受失败则不采取行动；
3. RTS/CTS 帧：可选的碰撞避免机制，主要用于解决“隐蔽站”的问题。如果站A要向站B发送数据，那么，站A在发送数据帧之前，要先向站B发送一个请求发送帧RTS(Request To Send)。在RTS帧中已说明将要发送的数据帧的长度。站B收到RTS帧后就向站A回应一个允许发送帧CTS(Clear To Send)。在CTS帧中也附上A欲发送的数据帧的长度(从RTS帧中将此数据复制到CTS帧中)。

### 轮询访问介质访问控制：令牌传递协议
令牌传递又称“标记传送”，局部网数据送取的一种控制方法，多用于令牌环局域网中。

令牌由专用的信息块组成，典型的令牌由连续的8位“1”组成。当网络所有节点都空闲时，令牌就从一个节点传送到下一个节点。当某一节点要求发送信息时，它必须获得令牌并在发送之前把它从网络上取走。一旦传送完数据，就把令牌转送给下一个节点，每个节点都具备有发送/接收令牌的装置。使用这种传送方法决不会发生碰撞，这是因为在某一瞬间只有一个节点有可能传送数据。最大的问题是令牌在传送过程中丢失或受到破坏，从而使节点找不到令牌从而无法传送信息。

轮询介质访问控制的传输介质物理拓扑不一定是个环，但在逻辑通路上是个环。它非常适合高负载的广播信道。

## 局域网
### 局域网的基本概念和体系结构
局域网是一种典型的广播信道，主要特点是网络为一个单位所拥有，且地理范围和站点数目均有限。主要有以太网、令牌环网、FDDI 和 ATM 等局域网技术，目前以太网占领着有线局域网市场。

可以按照网络拓扑结构对局域网进行分类：

网络|逻辑拓扑|物理拓扑
--|--|--
以太网（目前使用范围最广的局域网）|总线型结构|星型结构
令牌环（Token Ring，IEEE802.5）|环形结构|星型结构
FDDI（光线分布数字接口，IEEE802.8）|环形结构|双环结构

### 以太网与 IEEE 802.3

快速以太网（100BASE-T、1000BASE-T标准）为了减少冲突，将能提高的网络速度和使用效率最大化，使用集线器来进行网络连接和组织。如此一来，以太网的拓扑结构就成了星型；但在逻辑上，以太网仍然使用总线型拓扑和CSMA/CD（Carrier Sense Multiple Access/Collision Detection，即载波多重访问/碰撞侦测）的总线技术。

目前以太网使用交换机（网桥）替代了集线器，交换机是一种链路层设备，它不会发生碰撞，能根据 MAC 地址进行存储转发。

以太网 MAC 帧格式：

![以太网MAC帧](/Net/以太网MAC帧.jpg)

- **前导码** ：使接收端与发送端时钟同步；
- **类型** ：标记数据域中使用的协议；
- **数据** ：长度在 46-1500 之间，如果太小则需要填充。其中 46=64-18 ，即可以满足以太网最短帧长，1500 则是人为规定的；
- **FCS** ：帧检验序列（校验码），使用的是 CRC 检验方法；

### IEEE 802.11

IEEE 802.11是现今无线局域网通用的标准，它是由国际电机电子工程学会（IEEE）所定义的无线网络通信的标准。虽然经常将Wi-Fi与802.11混为一谈，但两者并不等同。802.11 定义了媒体访问控制层（MAC层）和物理层。物理层定义了工作在 2.4GHz 的 ISM 频段上的两种扩频作调制方式和一种红外线传输的方式，总数据传输速率设计为 2Mbit/s。两个设备可以自行构建临时网络，也可以在基站（Base Station, BS）或者接入点（Access Point，AP）的协调下通信。采用 CSMA/CA（Carrier Sense Multiple Access/Collision Avoidance）硬件沟通方式。

1. 有固定基础设施无线局域网：802.11 标准规定无线局域网最小构件是 **基本服务集**（Basic Service Set, BSS），其中包括一个基站和若干移动站。所有站在本 BSS 内都可以直接通信，但和在本 BSS 以外的站通信时就要经过基站，又被称作 **接入点**（Access Point，AP）。AP 又可以连接到一个 **主干分配系统**（Distribution System, DS），然后再接入另一个基本服务集，构成 **拓展服务集**（Extended Service Set, ESS）。ESS 还可以通过门桥（Portal）为无线用户提供到因特网的接入，门桥的作用就相当于网桥。
2. 无固定基础设施的无线局域网自组织网络（Ad Hoc Network）：自组织网络没有 AP ，而是由一些处于平等状态的移动站之间相互通信组成的临时网络。这些结点都具有路由器的功能。

### 令牌环网的基本原理
令牌环网络的基本原理是利用令牌（代表发信号的许可）来避免网络中的冲突，它与使用冲突检测算法 CSMA/CD 的以太网相比能提高网络的数据传送率。此外，它还可以设置发送的优先度。一个 4M 的令牌环网络和一个 10M 的以太网数据传送率相当，一个 16M 的令牌环网络的数据传送率接近一个 100M 的以太网。但这种网络不可复用，导致网络利用率低下。当网络中一个结点拿到令牌而使用网络后，不管此结点使用多少带宽，其他结点都必须等待其使用完网络并放弃令牌后才有机会申请令牌并使用网络。此外，网络中还需专门结点维护令牌。


### 虚拟局域网

虚拟局域网可以建立与物理位置无关的逻辑组，只有在同一个虚拟局域网中的成员才会收到链路层广播信息。

![虚拟局域网](/Net/虚拟局域网.png)

例如上图中 (A1, A2, A3, A4) 属于一个虚拟局域网，A1 发送的广播会被 A2、A3、A4 收到，而其它站点收不到。

使用 VLAN 干线连接来建立虚拟局域网，每台交换机上的一个特殊接口被设置为干线接口，以互连 VLAN 交换机。IEEE 定义了一种扩展的以太网帧格式 802.1Q，它在标准以太网帧上加进了 4 字节首部 VLAN 标签，用于表示该帧属于哪一个虚拟局域网。

## 广域网
广域网（英语：Wide Area Network，缩写为 WAN），又称广域网、外网、公网。是连接不同地区局域网或城域网计算机通信的远程网。通常跨接很大的物理范围，所覆盖的范围从几十公里到几千公里，它能连接多个地区、城市和国家，或横跨几个洲并能提供远距离通信，形成国际性的远程网络。广域网并不等同于互联网，互联网可以连接不同类型的网络，通常使用路由器进行连接。

广域网由结点交换机（而非路由器，路由器在多个网络构成中转发分组，而结点交换机在单个网络构成中转发分组）以及连接这些交换机的链路组成。PPP 协议与 HDLC 协议是目前最常用的两种广域网数据链路层控制协议。

### PPP 协议
点对点协议（英语：Point-to-Point Protocol，PPP）工作在数据链路层。它通常用在两节点间创建直接的连接，并可以提供连接认证、传输加密以及压缩。它一般是由软件的形式实现，故使用字节填充（而非为填充）来实现透明传输。

互联网服务提供商（ISP）使用 PPP 为用户提供到Internet的拨号接入，这是因为 IP 报文无法在没有数据链路协议的情况下通过调制解调器线路自行传输。PPP 的两个派生物 PPPoE 和 PPPoA 被 ISP 广泛用来与用户创建数字用户线路（DSL）Internet 服务连接。

PPP 可用作连接同步和异步电路的数据链路层协议，并取代了陈旧的串行线路 IP协议（SLIP）。PPP 被设计用来与不同网络层协议协同工作，包括网际协议（IP）、TRILL、Novell 的互联网分组交换协议（IPX）、NBF 以及 AppleTalk。

PPP 三个组成部分：
1. 链路控制协议 LCP：使用标示自己的特殊数字作为特征来发现、建立、配置、测试、管理回路。当使用PPP 协议的时候，端点发出具有和其他端点都不相同的特殊数字标识的 LCP 信息，如果线路存在回路，发出这个信息的端点就会收到含有自己标识的信息；
2. 网络控制协议 NCP：用来标志所使用的网络层协议；
3. 一个将 IP 数据报封装到串行链路的方法，这受到最大传送单元 MTU（Maximum Transmission Unit） 的限制。

PPP 的帧格式：

名称|	字节数|	描述
--|--|--
标记 F|	1	|标记出帧的头或尾
地址 A|	1	|广播地址
控制 C|	1	|控制字
协议|	2	|数据报文中所使用的协议
数据|	不定长(0-1500B)	|数据报文
冗余填充|	不定长(0或更多)	|可选的冗余填充
帧校验序列 FCS|	2(或4)	|错误校验

ps. 因为 PPP 协议是点对点的，并不是总线型，所以无需采用 CSMA/CD 协议，便没有最短帧的限制，而且不使用序号与确认机制。它提供差错检测（CRC 校验）但不提供纠错功能，提供无差错接受，但端到端的可靠性由高层协议负责。PPP 只支持全双工链路，在数据部分出现和标志位一样的比特组合时，就需要采用一些措施来实现透明传输。

### HDLC 协议
高级数据链路控制（High-Level Data Link Control或简称HDLC），是一个在同步网上传输数据、**面向比特**（PPP 协议则**面向字节**）的数据链路层协议。该协议不依赖于任何一种字符编码集；数据包文可透明传输，“0 比特插入法”容易实现；全双工通信；信息帧顺序编号；所有帧采用 CRC 检验。

HDLC 两种基本配置：
1. 非平衡配置：由一个主站控制整个链路的工作；
2. 平衡配置：链路两端的两个站都是复合站，每个复合站都可以平等地发起数据传输，而不需要得到对方复合站的允许。

**站**
- 主站：负责控制链路的操作，主站发出的帧称为命令帧；
- 从站：受控于主站，发出的帧称为响应帧；
- 复合站：兼具主站与从站的功能。

**数据操作方式**
名称|操作方式|描述
--|--|--
正常响应的方式|非平衡结构|主站向从站传输数据，从站进行响应传输，但从站只有在收到主站的许可后才可进行响应
异步平衡方式|平衡结构|每一个复合站都可以对另一站进行传输
异步响应方式|非平衡结构|从站在没有接收到主站的许可下就可以进行传输

**HDLC 帧**

![HDLC](/Net/hdlc.jpg)

在HDLC的帧格式中，在起始标志 F 后的是地址字段 A 和控制字段 C，然后是长度在 0 到 5000 八位位组（octet）的数据字段和帧检验序列字段 FSC ，最后是作为结束标志的帧界定符 F 。

其中地址段 A 在非平衡方式传输数据时写入从站地址，在平衡方式时写入应答站地址。

当暂时没有信息传送时，帧界定符被连续地发送直到下一次数据发送为止，产生如下图的连续比特流：
```c
//标识字段 F 为： 01111110

01111110011111100111111001111110
 ______  ______  ______  ______ 
_      __      __      __      _
```

## 数据链路层设备

### 桥接器/网桥
桥接器（Network Bridge），又称网桥，是一种网络设备，负责网络桥接之用。桥接器将网络的多个网段在数据链路层连接起来（即桥接）。两个或多个以太网通过网桥连接后，就可成为一个覆盖范围更大的以太网，原来的以太网则成为一个网段（Network Segment）。网桥工作在链路层的 MAC 子层，可以使以太网各网段成为隔离开的碰撞域。

- 网桥能够识别数据链路层中的数据帧，并将这些数据帧临时存储于内存，再重新生成信号作为一个全新的数据帧转发给相连的另一个网段。由于能够对数据帧拆包、暂存、重新打包（称为存储转发机制 store-and-forward），网桥能够连接不同技术参数传输速率的数据链路；
- 网桥可以检查FCS，将那些损坏的数据帧丢弃；
- 网桥在向其他网段转发数据帧时会做冲突检测控制；
- 网桥还能通过地址自学机制和过滤功能控制网络流量，其机制是网桥内部有一个数据库当网桥从一个网段收到一个数据帧，就会在数据库中登记（或者更新）数据帧的源地址属于这个网段，并检查数据包的目的地址。如果目的地址在数据库中属于另外一个网段，则网桥向该网段转发该数据帧；如果目的地址在数据库中没有记录，则网桥向除了源地址所在之外的其他所有网段转发（flood）该数据帧；
- 若有通信频繁的机器，则应置于同区之内，否则性能将降低。

根据路径选择算法的不同，网桥可分为：
1. 透明网桥（非最佳路由）：网桥收到一帧后先进行自学习:
    1. 如果源 LAN 和目的 LAN 相同，则丢弃该帧；
    2. 如果源 LAN 和目的 LAN 不同，则转发该帧；
    3. 如果目的 LAN 未知，则进行扩散。

    为防止产生死循环，透明网桥还使用了一个生成树（spanning tree）算法，即互连在一起的网桥在进行彼此通信后，就能找出原来的网络拓扑的一个子集。在网桥的转发表中写入的信息除了地址和接口外，还有帧进入该网桥的时间。网桥中的接口管理软件周期性的扫描转发表中的项目。只要在一定时间以前登记的都要删除。
2. 源路由网桥（最佳路由）：源路由网桥对主机不是透明的，主机必须知道网桥的标识以及连接到哪一个网段上。源站以广播方式向欲通信的目的站发送一个发现帧，每个发现帧都记录所经过的路由。发现帧到达目的站时就沿各自的路由返回源站。源站在得知这些路由后，从所有可能的路由中选择出一个最佳路由。凡从该源站向该目的站发送的帧的首部，都必须携带源站所确定的这一路由信息，这可能使网络严重拥塞。

在一个时期，透明网桥和源路由网桥是各自独立发展的。但随之而来的需求是要设计一种方式来满足通过透明网桥互联的局域网和通过源路由网桥互联的局域网之间的连接。最终，所有的标准网桥都必须支持透明网桥，而源路由则被作为一个可选配的附加特性。

### 局域网交换机

与桥接器相比，以太网交换机（即局域网交换机）不仅仅能隔离冲突域，还能隔离广播域。桥接器的端口往往连接到以太网的某个网段，而以太网交换机每个端口都与单独主机相连，并使用全双工工作方式。以太网交换机采用专门的交换结构芯片，转发速度比网桥快，并且它可以同时连接多对端口。

以太网交换机具有自学习能力，学习的是交换表的内容，交换表中存储着 MAC 地址到接口的映射。正是由于这种自学习能力，因此交换机是一种即插即用设备，不需要网络管理员手动配置交换表内容。不同虚拟局域网（VLAN ）之间的通讯需要通过路由器来完成，另外为了实现不同的网段之间通讯也需要路由器进行互连。

帧交换是当前应用的最广的局域网交换技术，对网络帧的处理方式一般有：存储转发式和直通式两种：
- 存储转发式 (Store-and-Forward) ：当一个数据包以这种技术进入一个交换机时，交换机将读取足够的信息，以便不仅能决定哪个端口将被用来发送该数据包，而且还能决定是否发送该数据包，能有效地排除了那些有缺陷的网络段。虽然这种方式不及使用直通式产品的交换速度，但是它们却能排除由破坏的数据包所引起的经常性的有害后果。
- 直通式 (Cut-Through) ：当一个数据包使用这种技术进入一个交换机时，它的地址将被读取。然后不管该数据包是否为错误的格式，它都将被发送。由于数据包只有开头几个字节被读取，所以这种方法提供了较多的交换次数。如果网络接口卡失效，或电缆存在缺陷；或有一个能引起数据包遭破坏的外部信号源，则出错将十分频繁。虽然交换速度很快，但缺乏对网络帧的高级控制，无智能性和安全性可言，同时也无法支持具有不同速率端口的交换。